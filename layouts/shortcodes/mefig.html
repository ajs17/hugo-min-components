
{{ $pagebundlepath := .Get 3  | default (.Page.Params.defaultPageBundle) }}
    {{ $pagebundle := .Page.GetPage $pagebundlepath }}

{{ $basename := .Get 0 }}
    {{ $fileref := printf "images/%s.*" $basename }}
    {{ $resourceid := .Get 0 }}
    {{ if not (strings.HasSuffix $resourceid "md") }}
        {{ $resourceid = printf "%s.md" $resourceid }}
    {{ end }}
    {{ $resource := $pagebundle.Resources.GetMatch $resourceid }}
    {{ if $resource }}
        {{ $fileref = $resource.Params.fileref | default $fileref }}
    {{ else }}
        {{ if not hugo.IsProduction }}
            no resource file at {{ $pagebundlepath }} / {{ $resourceid }}
        {{ end }}
    {{ end }}

{{ $width := $.Site.Params.ImageMaxWidth | default "800" }}
{{ $height := "" }}
{{ $size := .Get 1  }}
{{ with $size }}
    {{ if in . "x" }}
        {{ $dims := split . "x"}}
        {{ $width = index $dims 0 }}
        {{ $height = index $dims (sub (len $dims) 1)  }}
    {{ else }}
        {{ $width = . }}
    {{ end }}
{{ end }}
{{ $resize := printf "%sx%s" $width $height }}

{{ $displays := .Get 2 | default "img,blockquote,figcaption,footer,aside"  }}

<figure style="max-width: {{ $width }}px;">
{{ $orighref := $fileref }}

{{ if in $displays "img" }}
    {{ $image := $pagebundle.Resources.GetMatch $fileref }}
    {{ if $image }}
        {{ $orighref = $image.RelPermalink }}
        {{ $image = $image.Resize $resize }}
        {{ with $image }}
            {{ $alt := .Title }}
            {{ if $resource }}
                {{- $alt = $resource.Params.alt | markdownify -}}
            {{ end }}
<img src="{{ .RelPermalink }}" width="{{ .Width }}" height="{{ .Height }}" alt="{{ $alt }} ">
        {{ end }}
    {{ else }}
        {{ if not hugo.IsProduction }}
            no image at {{ $pagebundlepath }} / {{ $fileref }}
        {{ end }}
    {{ end }}
{{ end }}

{{ if and (in $displays "blockquote") $resource  }}
    {{ $quote := $resource.Content }}
    {{ if .Inner }}
        {{ $quote = .Inner }}
    {{ end }}
    {{ with $quote }}
<blockquote>{{- . | markdownify  -}}</blockquote>
    {{ end }}
{{ end }}

{{ if and (in $displays "figcaption") $resource }}
<figcaption>
    {{ with $resource.Params.citation }}
â€” <cite>{{- . | markdownify -}}</cite>&nbsp;
    {{- end -}}
    {{- with $orighref -}}
<a href="{{ . }}">View largest available size.</a>
    {{- end -}}
</figcaption>
{{ end }}

{{ if and (in $displays "footer") $resource  }}
<footer>
{{- $resource.Params.notes | markdownify -}}
</footer>
{{ end }}
{{ if and (in $displays "aside") $resource  }}
    {{ with $resource.Params.aside }}
<aside>
{{- . | markdownify -}}
</aside>
    {{ end }}
{{ end }}
 
</figure>






