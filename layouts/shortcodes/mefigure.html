
{{ $filename := .Get 0  }}
{{ $citation := .Get 1  }}
{{ $maxwidth := .Get 2 | default ($.Site.Params.ImageMaxWidth | default "800") }}

{{ $dims := printf "%sx" $maxwidth }}

<figure style="max-width: {{ $maxwidth }}px;">

{{- $image := .Page.Resources.GetMatch $filename -}}
{{ with $image }}
    {{ if gt $image.Width $maxwidth }}
    {{  $image = $image.Resize $dims }}
    {{ end }}
<img src="{{ $image.RelPermalink }}" width="{{ $image.Width }}" height="{{ $image.Height }}" alt="{{ $citation}} ">
{{ end }}
{{ $dirFile := path.Split $filename }}
{{ $basename := index (split $dirFile.File "." ) 0 }}
{{ $mdfilepath := printf "%s%s%s" $dirFile.Dir $basename ".md" }}
{{ $mdfile := .Page.Resources.GetMatch $mdfilepath }}
{{ if $mdfile }}
{{ $content := $mdfile.Content }}
{{ with $content }}<blockquote>{{ $content  | markdownify  }}</blockquote>{{ end }}
{{ end }}

<figcaption>
{{ if $citation }}â€” <cite>{{ $citation | markdownify }}</cite>&nbsp;{{ end }}
<a href="{{ $filename }}">View largest available size.</a>
</figcaption>

{{ .Inner }}

</figure>
